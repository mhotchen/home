#!/bin/bash

sudo apt update
sudo apt upgrade
sudo apt install --yes \
	curl \
	git \
	keepassx \
	krita \
	qmapshack \
	python3-gpg \
	vim \
	virtualbox \
	vlc
sudo apt autoremove
snap install spotify
snap install --classic intellij webstorm datagrip slack
git config --global user.email "m@mhn.me"
git config --global user.name "Matthew Hotchen"
systemctl --user enable dropbox.service
systemctl --user start dropbox.service

while [ ! -f ~/Dropbox/keepass.kdbx ]
do
	curl \
		--output dropbox.deb \
		--location \
		https://www.dropbox.com/download?dl=packages/ubuntu/dropbox_2020.03.04_amd64.deb
	sudo dpkg -i dropbox.deb
	read -p "Please run Dropbox from the application launcher and configure it"
done

if ! grep source-bashrc-d -lq .bashrc; then
	cat <<- EOF >> .bashrc

		# source-bashrc-d
		for file in .bashrc.d/*.sh; do
			source "\$file"
		done
	EOF
fi

for file in .bashrc.d/*.sh; do
	source "$file"
done

gpg --import ~/Dropbox/master.key
gpg --import ~/Dropbox/sub.key

keyGrip=$(gpg --list-keys --with-keygrip | grep -A 1 "\[A\]" | grep Keygrip | awk '{print $3}')
while [ ! -f ~/.gpg2/sshcontrol ]
do
	echo "$keyGrip" > .gpg2/sshcontrol
	chmod u+rw,g-rwx,o-rwx ~/.gpg2/sshcontrol
done

git remote set-url origin git@github.com:mhotchen/home.git
